<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>display_width.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg==">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNTMgMTQwIj48ZyBmaWxsPSIjRjdBNDFEIj48Zz48cG9seWdvbiBwb2ludHM9IjQ2LDIyIDI4LDQ0IDE5LDMwIi8+PHBvbHlnb24gcG9pbnRzPSI0NiwyMiAzMywzMyAyOCw0NCAyMiw0NCAyMiw5NSAzMSw5NSAyMCwxMDAgMTIsMTE3IDAsMTE3IDAsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMzEsOTUgMTIsMTE3IDQsMTA2Ii8+PC9nPjxnPjxwb2x5Z29uIHBvaW50cz0iNTYsMjIgNjIsMzYgMzcsNDQiLz48cG9seWdvbiBwb2ludHM9IjU2LDIyIDExMSwyMiAxMTEsNDQgMzcsNDQgNTYsMzIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTE2LDk1IDk3LDExNyA5MCwxMDQiLz48cG9seWdvbiBwb2ludHM9IjExNiw5NSAxMDAsMTA0IDk3LDExNyA0MiwxMTcgNDIsOTUiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTUwLDAgNTIsMTE3IDMsMTQwIDEwMSwyMiIvPjwvZz48Zz48cG9seWdvbiBwb2ludHM9IjE0MSwyMiAxNDAsNDAgMTIyLDQ1Ii8+PHBvbHlnb24gcG9pbnRzPSIxNTMsMjIgMTUzLDExNyAxMDYsMTE3IDEyMCwxMDUgMTI1LDk1IDEzMSw5NSAxMzEsNDUgMTIyLDQ1IDEzMiwzNiAxNDEsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTI1LDk1IDEzMCwxMTAgMTA2LDExNyIvPjwvZz48L2c+PC9zdmc+">
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-comment">//! `display_width` provides functions that calculate the display width of a code point or string when displayed in a</span></span>
<span class="line" id="L2"><span class="tok-comment">//! fixed-width font.</span></span>
<span class="line" id="L3"></span>
<span class="line" id="L4"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L5"><span class="tok-kw">const</span> unicode = std.unicode;</span>
<span class="line" id="L6"></span>
<span class="line" id="L7"><span class="tok-kw">const</span> cats = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ziglyph.zig&quot;</span>).general_category;</span>
<span class="line" id="L8"><span class="tok-kw">const</span> eaw = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ziglyph.zig&quot;</span>).east_asian_width;</span>
<span class="line" id="L9"><span class="tok-kw">const</span> emoji = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ziglyph.zig&quot;</span>).emoji;</span>
<span class="line" id="L10"><span class="tok-kw">const</span> gbp = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ziglyph.zig&quot;</span>).grapheme_break;</span>
<span class="line" id="L11"><span class="tok-kw">const</span> GraphemeIterator = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ziglyph.zig&quot;</span>).GraphemeIterator;</span>
<span class="line" id="L12"><span class="tok-kw">const</span> Word = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ziglyph.zig&quot;</span>).Word;</span>
<span class="line" id="L13"><span class="tok-kw">const</span> WordIterator = Word.WordIterator;</span>
<span class="line" id="L14"></span>
<span class="line" id="L15"><span class="tok-kw">fn</span> <span class="tok-fn">isAsciiStr</span>(str: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L16">    <span class="tok-kw">return</span> <span class="tok-kw">for</span> (str) |b| {</span>
<span class="line" id="L17">        <span class="tok-kw">if</span> (b &gt; <span class="tok-number">127</span>) <span class="tok-kw">break</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L18">    } <span class="tok-kw">else</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L19">}</span>
<span class="line" id="L20"></span>
<span class="line" id="L21"><span class="tok-comment">/// AmbiguousWidth determines the width of ambiguous characters according to the context. In an</span></span>
<span class="line" id="L22"><span class="tok-comment">/// East Asian context, the width of ambiguous code points should be 2 (full), and 1 (half)</span></span>
<span class="line" id="L23"><span class="tok-comment">/// in non-East Asian contexts. The most common use case is `half`.</span></span>
<span class="line" id="L24"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> AmbiguousWidth = <span class="tok-kw">enum</span>(<span class="tok-type">u2</span>) {</span>
<span class="line" id="L25">    half = <span class="tok-number">1</span>,</span>
<span class="line" id="L26">    full = <span class="tok-number">2</span>,</span>
<span class="line" id="L27">};</span>
<span class="line" id="L28"></span>
<span class="line" id="L29"><span class="tok-comment">/// codePointWidth returns how many cells (or columns) wide `cp` should be when rendered in a</span></span>
<span class="line" id="L30"><span class="tok-comment">/// fixed-width font.</span></span>
<span class="line" id="L31"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">codePointWidth</span>(cp: <span class="tok-type">u21</span>, am_width: AmbiguousWidth) <span class="tok-type">i3</span> {</span>
<span class="line" id="L32">    <span class="tok-kw">if</span> (cp == <span class="tok-number">0x000</span> <span class="tok-kw">or</span> cp == <span class="tok-number">0x0005</span> <span class="tok-kw">or</span> cp == <span class="tok-number">0x0007</span> <span class="tok-kw">or</span> (cp &gt;= <span class="tok-number">0x000A</span> <span class="tok-kw">and</span> cp &lt;= <span class="tok-number">0x000F</span>)) {</span>
<span class="line" id="L33">        <span class="tok-comment">// Control.</span>
</span>
<span class="line" id="L34">        <span class="tok-kw">return</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L35">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (cp == <span class="tok-number">0x0008</span> <span class="tok-kw">or</span> cp == <span class="tok-number">0x007F</span>) {</span>
<span class="line" id="L36">        <span class="tok-comment">// backspace and DEL</span>
</span>
<span class="line" id="L37">        <span class="tok-kw">return</span> -<span class="tok-number">1</span>;</span>
<span class="line" id="L38">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (cp == <span class="tok-number">0x00AD</span>) {</span>
<span class="line" id="L39">        <span class="tok-comment">// soft-hyphen</span>
</span>
<span class="line" id="L40">        <span class="tok-kw">return</span> <span class="tok-number">1</span>;</span>
<span class="line" id="L41">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (cp == <span class="tok-number">0x2E3A</span>) {</span>
<span class="line" id="L42">        <span class="tok-comment">// two-em dash</span>
</span>
<span class="line" id="L43">        <span class="tok-kw">return</span> <span class="tok-number">2</span>;</span>
<span class="line" id="L44">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (cp == <span class="tok-number">0x2E3B</span>) {</span>
<span class="line" id="L45">        <span class="tok-comment">// three-em dash</span>
</span>
<span class="line" id="L46">        <span class="tok-kw">return</span> <span class="tok-number">3</span>;</span>
<span class="line" id="L47">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (cats.isEnclosingMark(cp) <span class="tok-kw">or</span> cats.isNonspacingMark(cp)) {</span>
<span class="line" id="L48">        <span class="tok-comment">// Combining Marks.</span>
</span>
<span class="line" id="L49">        <span class="tok-kw">return</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L50">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (cats.isFormat(cp) <span class="tok-kw">and</span> (!(cp &gt;= <span class="tok-number">0x0600</span> <span class="tok-kw">and</span> cp &lt;= <span class="tok-number">0x0605</span>) <span class="tok-kw">and</span> cp != <span class="tok-number">0x061C</span> <span class="tok-kw">and</span></span>
<span class="line" id="L51">        cp != <span class="tok-number">0x06DD</span> <span class="tok-kw">and</span> cp != <span class="tok-number">0x08E2</span>))</span>
<span class="line" id="L52">    {</span>
<span class="line" id="L53">        <span class="tok-comment">// Format except Arabic.</span>
</span>
<span class="line" id="L54">        <span class="tok-kw">return</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L55">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> ((cp &gt;= <span class="tok-number">0x1160</span> <span class="tok-kw">and</span> cp &lt;= <span class="tok-number">0x11FF</span>) <span class="tok-kw">or</span> (cp &gt;= <span class="tok-number">0x2060</span> <span class="tok-kw">and</span> cp &lt;= <span class="tok-number">0x206F</span>) <span class="tok-kw">or</span></span>
<span class="line" id="L56">        (cp &gt;= <span class="tok-number">0xFFF0</span> <span class="tok-kw">and</span> cp &lt;= <span class="tok-number">0xFFF8</span>) <span class="tok-kw">or</span> (cp &gt;= <span class="tok-number">0xE0000</span> <span class="tok-kw">and</span> cp &lt;= <span class="tok-number">0xE0FFF</span>))</span>
<span class="line" id="L57">    {</span>
<span class="line" id="L58">        <span class="tok-comment">// Hangul syllable and ignorable.</span>
</span>
<span class="line" id="L59">        <span class="tok-kw">return</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L60">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> ((cp &gt;= <span class="tok-number">0x3400</span> <span class="tok-kw">and</span> cp &lt;= <span class="tok-number">0x4DBF</span>) <span class="tok-kw">or</span> (cp &gt;= <span class="tok-number">0x4E00</span> <span class="tok-kw">and</span> cp &lt;= <span class="tok-number">0x9FFF</span>) <span class="tok-kw">or</span></span>
<span class="line" id="L61">        (cp &gt;= <span class="tok-number">0xF900</span> <span class="tok-kw">and</span> cp &lt;= <span class="tok-number">0xFAFF</span>) <span class="tok-kw">or</span> (cp &gt;= <span class="tok-number">0x20000</span> <span class="tok-kw">and</span> cp &lt;= <span class="tok-number">0x2FFFD</span>) <span class="tok-kw">or</span></span>
<span class="line" id="L62">        (cp &gt;= <span class="tok-number">0x30000</span> <span class="tok-kw">and</span> cp &lt;= <span class="tok-number">0x3FFFD</span>))</span>
<span class="line" id="L63">    {</span>
<span class="line" id="L64">        <span class="tok-kw">return</span> <span class="tok-number">2</span>;</span>
<span class="line" id="L65">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (eaw.isWide(cp) <span class="tok-kw">or</span> eaw.isFullwidth(cp)) {</span>
<span class="line" id="L66">        <span class="tok-kw">return</span> <span class="tok-number">2</span>;</span>
<span class="line" id="L67">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (gbp.isRegionalIndicator(cp)) {</span>
<span class="line" id="L68">        <span class="tok-kw">return</span> <span class="tok-number">2</span>;</span>
<span class="line" id="L69">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (eaw.isAmbiguous(cp)) {</span>
<span class="line" id="L70">        <span class="tok-kw">return</span> <span class="tok-builtin">@intFromEnum</span>(am_width);</span>
<span class="line" id="L71">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L72">        <span class="tok-kw">return</span> <span class="tok-number">1</span>;</span>
<span class="line" id="L73">    }</span>
<span class="line" id="L74">}</span>
<span class="line" id="L75"></span>
<span class="line" id="L76"><span class="tok-comment">/// strWidth returns how many cells (or columns) wide `str` should be when rendered in a</span></span>
<span class="line" id="L77"><span class="tok-comment">/// fixed-width font.</span></span>
<span class="line" id="L78"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">strWidth</span>(str: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, am_width: AmbiguousWidth) !<span class="tok-type">usize</span> {</span>
<span class="line" id="L79">    <span class="tok-kw">var</span> total: <span class="tok-type">isize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L80"></span>
<span class="line" id="L81">    <span class="tok-comment">// ASCII bytes are all width == 1.</span>
</span>
<span class="line" id="L82">    <span class="tok-kw">if</span> (isAsciiStr(str)) {</span>
<span class="line" id="L83">        <span class="tok-kw">for</span> (str) |b| {</span>
<span class="line" id="L84">            <span class="tok-comment">// Backspace and DEL</span>
</span>
<span class="line" id="L85">            <span class="tok-kw">if</span> (b == <span class="tok-number">8</span> <span class="tok-kw">or</span> b == <span class="tok-number">127</span>) {</span>
<span class="line" id="L86">                total -= <span class="tok-number">1</span>;</span>
<span class="line" id="L87">                <span class="tok-kw">continue</span>;</span>
<span class="line" id="L88">            }</span>
<span class="line" id="L89"></span>
<span class="line" id="L90">            <span class="tok-comment">// Control</span>
</span>
<span class="line" id="L91">            <span class="tok-kw">if</span> (b &lt; <span class="tok-number">32</span>) <span class="tok-kw">continue</span>;</span>
<span class="line" id="L92"></span>
<span class="line" id="L93">            <span class="tok-comment">// All other ASCII.</span>
</span>
<span class="line" id="L94">            total += <span class="tok-number">1</span>;</span>
<span class="line" id="L95">        }</span>
<span class="line" id="L96"></span>
<span class="line" id="L97">        <span class="tok-kw">return</span> <span class="tok-kw">if</span> (total &gt; <span class="tok-number">0</span>) <span class="tok-builtin">@intCast</span>(total) <span class="tok-kw">else</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L98">    }</span>
<span class="line" id="L99"></span>
<span class="line" id="L100">    <span class="tok-kw">var</span> giter = GraphemeIterator.init(str);</span>
<span class="line" id="L101"></span>
<span class="line" id="L102">    <span class="tok-kw">while</span> (giter.next()) |gc| {</span>
<span class="line" id="L103">        <span class="tok-kw">var</span> cp_iter = (<span class="tok-kw">try</span> unicode.Utf8View.init(str[gc.offset .. gc.offset + gc.len])).iterator();</span>
<span class="line" id="L104"></span>
<span class="line" id="L105">        <span class="tok-kw">while</span> (cp_iter.nextCodepoint()) |cp| {</span>
<span class="line" id="L106">            <span class="tok-kw">var</span> w = codePointWidth(cp, am_width);</span>
<span class="line" id="L107"></span>
<span class="line" id="L108">            <span class="tok-kw">if</span> (w != <span class="tok-number">0</span>) {</span>
<span class="line" id="L109">                <span class="tok-comment">// Only adding width of first non-zero-width code point.</span>
</span>
<span class="line" id="L110">                <span class="tok-kw">if</span> (emoji.isExtendedPictographic(cp)) {</span>
<span class="line" id="L111">                    <span class="tok-kw">if</span> (cp_iter.nextCodepoint()) |ncp| {</span>
<span class="line" id="L112">                        <span class="tok-comment">// emoji text sequence.</span>
</span>
<span class="line" id="L113">                        <span class="tok-kw">if</span> (ncp == <span class="tok-number">0xFE0E</span>) w = <span class="tok-number">1</span>;</span>
<span class="line" id="L114">                        <span class="tok-kw">if</span> (ncp == <span class="tok-number">0xFE0F</span>) w = <span class="tok-number">2</span>;</span>
<span class="line" id="L115">                    }</span>
<span class="line" id="L116">                }</span>
<span class="line" id="L117">                total += w;</span>
<span class="line" id="L118">                <span class="tok-kw">break</span>;</span>
<span class="line" id="L119">            }</span>
<span class="line" id="L120">        }</span>
<span class="line" id="L121">    }</span>
<span class="line" id="L122"></span>
<span class="line" id="L123">    <span class="tok-kw">return</span> <span class="tok-kw">if</span> (total &gt; <span class="tok-number">0</span>) <span class="tok-builtin">@intCast</span>(total) <span class="tok-kw">else</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L124">}</span>
<span class="line" id="L125"></span>
<span class="line" id="L126"><span class="tok-comment">/// centers `str` in a new string of width `total_width` (in display cells) using `pad` as padding.</span></span>
<span class="line" id="L127"><span class="tok-comment">/// If the length of `str` and `total_width` have different parity, the right side of `str` will</span></span>
<span class="line" id="L128"><span class="tok-comment">/// receive one additional pad. This makes sure the returned string fills the requested width.</span></span>
<span class="line" id="L129"><span class="tok-comment">/// Caller must free returned bytes.</span></span>
<span class="line" id="L130"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">center</span>(allocator: std.mem.Allocator, str: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, total_width: <span class="tok-type">usize</span>, pad: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) ![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L131">    <span class="tok-kw">const</span> str_width = <span class="tok-kw">try</span> strWidth(str, .half);</span>
<span class="line" id="L132">    <span class="tok-kw">if</span> (str_width &gt; total_width) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.StrTooLong;</span>
<span class="line" id="L133">    <span class="tok-kw">if</span> (str_width == total_width) <span class="tok-kw">return</span> <span class="tok-kw">try</span> allocator.dupe(<span class="tok-type">u8</span>, str);</span>
<span class="line" id="L134"></span>
<span class="line" id="L135">    <span class="tok-kw">const</span> pad_width = <span class="tok-kw">try</span> strWidth(pad, .half);</span>
<span class="line" id="L136">    <span class="tok-kw">if</span> (pad_width &gt; total_width <span class="tok-kw">or</span> str_width + pad_width &gt; total_width) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PadTooLong;</span>
<span class="line" id="L137"></span>
<span class="line" id="L138">    <span class="tok-kw">const</span> margin_width = <span class="tok-builtin">@divFloor</span>((total_width - str_width), <span class="tok-number">2</span>);</span>
<span class="line" id="L139">    <span class="tok-kw">if</span> (pad_width &gt; margin_width) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PadTooLong;</span>
<span class="line" id="L140">    <span class="tok-kw">const</span> extra_pad: <span class="tok-type">usize</span> = <span class="tok-kw">if</span> (total_width % <span class="tok-number">2</span> != str_width % <span class="tok-number">2</span>) <span class="tok-number">1</span> <span class="tok-kw">else</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L141">    <span class="tok-kw">const</span> pads = <span class="tok-builtin">@divFloor</span>(margin_width, pad_width) * <span class="tok-number">2</span> + extra_pad;</span>
<span class="line" id="L142"></span>
<span class="line" id="L143">    <span class="tok-kw">var</span> result = <span class="tok-kw">try</span> allocator.alloc(<span class="tok-type">u8</span>, pads * pad.len + str.len);</span>
<span class="line" id="L144">    <span class="tok-kw">var</span> bytes_index: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L145">    <span class="tok-kw">var</span> pads_index: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L146"></span>
<span class="line" id="L147">    <span class="tok-kw">while</span> (pads_index &lt; pads / <span class="tok-number">2</span>) : (pads_index += <span class="tok-number">1</span>) {</span>
<span class="line" id="L148">        <span class="tok-builtin">@memcpy</span>(result[bytes_index..][<span class="tok-number">0</span>..pad.len], pad);</span>
<span class="line" id="L149">        bytes_index += pad.len;</span>
<span class="line" id="L150">    }</span>
<span class="line" id="L151"></span>
<span class="line" id="L152">    <span class="tok-builtin">@memcpy</span>(result[bytes_index..][<span class="tok-number">0</span>..str.len], str);</span>
<span class="line" id="L153">    bytes_index += str.len;</span>
<span class="line" id="L154"></span>
<span class="line" id="L155">    pads_index = <span class="tok-number">0</span>;</span>
<span class="line" id="L156">    <span class="tok-kw">while</span> (pads_index &lt; pads / <span class="tok-number">2</span> + extra_pad) : (pads_index += <span class="tok-number">1</span>) {</span>
<span class="line" id="L157">        <span class="tok-builtin">@memcpy</span>(result[bytes_index..][<span class="tok-number">0</span>..pad.len], pad);</span>
<span class="line" id="L158">        bytes_index += pad.len;</span>
<span class="line" id="L159">    }</span>
<span class="line" id="L160"></span>
<span class="line" id="L161">    <span class="tok-kw">return</span> result;</span>
<span class="line" id="L162">}</span>
<span class="line" id="L163"></span>
<span class="line" id="L164"><span class="tok-comment">/// padLeft returns a new string of width `total_width` (in display cells) using `pad` as padding</span></span>
<span class="line" id="L165"><span class="tok-comment">/// on the left side.  Caller must free returned bytes.</span></span>
<span class="line" id="L166"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">padLeft</span>(allocator: std.mem.Allocator, str: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, total_width: <span class="tok-type">usize</span>, pad: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) ![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L167">    <span class="tok-kw">const</span> str_width = <span class="tok-kw">try</span> strWidth(str, .half);</span>
<span class="line" id="L168">    <span class="tok-kw">if</span> (str_width &gt; total_width) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.StrTooLong;</span>
<span class="line" id="L169"></span>
<span class="line" id="L170">    <span class="tok-kw">const</span> pad_width = <span class="tok-kw">try</span> strWidth(pad, .half);</span>
<span class="line" id="L171">    <span class="tok-kw">if</span> (pad_width &gt; total_width <span class="tok-kw">or</span> str_width + pad_width &gt; total_width) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PadTooLong;</span>
<span class="line" id="L172"></span>
<span class="line" id="L173">    <span class="tok-kw">const</span> margin_width = total_width - str_width;</span>
<span class="line" id="L174">    <span class="tok-kw">if</span> (pad_width &gt; margin_width) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PadTooLong;</span>
<span class="line" id="L175"></span>
<span class="line" id="L176">    <span class="tok-kw">const</span> pads = <span class="tok-builtin">@divFloor</span>(margin_width, pad_width);</span>
<span class="line" id="L177"></span>
<span class="line" id="L178">    <span class="tok-kw">var</span> result = <span class="tok-kw">try</span> allocator.alloc(<span class="tok-type">u8</span>, pads * pad.len + str.len);</span>
<span class="line" id="L179">    <span class="tok-kw">var</span> bytes_index: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L180">    <span class="tok-kw">var</span> pads_index: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L181"></span>
<span class="line" id="L182">    <span class="tok-kw">while</span> (pads_index &lt; pads) : (pads_index += <span class="tok-number">1</span>) {</span>
<span class="line" id="L183">        <span class="tok-builtin">@memcpy</span>(result[bytes_index..][<span class="tok-number">0</span>..pad.len], pad);</span>
<span class="line" id="L184">        bytes_index += pad.len;</span>
<span class="line" id="L185">    }</span>
<span class="line" id="L186"></span>
<span class="line" id="L187">    <span class="tok-builtin">@memcpy</span>(result[bytes_index..][<span class="tok-number">0</span>..str.len], str);</span>
<span class="line" id="L188"></span>
<span class="line" id="L189">    <span class="tok-kw">return</span> result;</span>
<span class="line" id="L190">}</span>
<span class="line" id="L191"></span>
<span class="line" id="L192"><span class="tok-comment">/// padRight returns a new string of width `total_width` (in display cells) using `pad` as padding</span></span>
<span class="line" id="L193"><span class="tok-comment">/// on the right side.  Caller must free returned bytes.</span></span>
<span class="line" id="L194"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">padRight</span>(allocator: std.mem.Allocator, str: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, total_width: <span class="tok-type">usize</span>, pad: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) ![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L195">    <span class="tok-kw">const</span> str_width = <span class="tok-kw">try</span> strWidth(str, .half);</span>
<span class="line" id="L196">    <span class="tok-kw">if</span> (str_width &gt; total_width) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.StrTooLong;</span>
<span class="line" id="L197"></span>
<span class="line" id="L198">    <span class="tok-kw">const</span> pad_width = <span class="tok-kw">try</span> strWidth(pad, .half);</span>
<span class="line" id="L199">    <span class="tok-kw">if</span> (pad_width &gt; total_width <span class="tok-kw">or</span> str_width + pad_width &gt; total_width) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PadTooLong;</span>
<span class="line" id="L200"></span>
<span class="line" id="L201">    <span class="tok-kw">const</span> margin_width = total_width - str_width;</span>
<span class="line" id="L202">    <span class="tok-kw">if</span> (pad_width &gt; margin_width) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PadTooLong;</span>
<span class="line" id="L203"></span>
<span class="line" id="L204">    <span class="tok-kw">const</span> pads = <span class="tok-builtin">@divFloor</span>(margin_width, pad_width);</span>
<span class="line" id="L205"></span>
<span class="line" id="L206">    <span class="tok-kw">var</span> result = <span class="tok-kw">try</span> allocator.alloc(<span class="tok-type">u8</span>, pads * pad.len + str.len);</span>
<span class="line" id="L207">    <span class="tok-kw">var</span> bytes_index: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L208">    <span class="tok-kw">var</span> pads_index: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L209"></span>
<span class="line" id="L210">    <span class="tok-builtin">@memcpy</span>(result[bytes_index..][<span class="tok-number">0</span>..str.len], str);</span>
<span class="line" id="L211">    bytes_index += str.len;</span>
<span class="line" id="L212"></span>
<span class="line" id="L213">    <span class="tok-kw">while</span> (pads_index &lt; pads) : (pads_index += <span class="tok-number">1</span>) {</span>
<span class="line" id="L214">        <span class="tok-builtin">@memcpy</span>(result[bytes_index..][<span class="tok-number">0</span>..pad.len], pad);</span>
<span class="line" id="L215">        bytes_index += pad.len;</span>
<span class="line" id="L216">    }</span>
<span class="line" id="L217"></span>
<span class="line" id="L218">    <span class="tok-kw">return</span> result;</span>
<span class="line" id="L219">}</span>
<span class="line" id="L220"></span>
<span class="line" id="L221"><span class="tok-comment">/// Wraps a string approximately at the given number of colums per line. Threshold defines how far the last column of</span></span>
<span class="line" id="L222"><span class="tok-comment">/// the last word can be from the edge. Caller must free returned bytes.</span></span>
<span class="line" id="L223"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">wrap</span>(allocator: std.mem.Allocator, str: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, columns: <span class="tok-type">usize</span>, threshold: <span class="tok-type">usize</span>) ![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L224">    <span class="tok-kw">var</span> iter = <span class="tok-kw">try</span> WordIterator.init(str);</span>
<span class="line" id="L225">    <span class="tok-kw">var</span> result = std.ArrayList(<span class="tok-type">u8</span>).init(allocator);</span>
<span class="line" id="L226">    <span class="tok-kw">defer</span> result.deinit();</span>
<span class="line" id="L227">    <span class="tok-kw">var</span> line_width: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L228"></span>
<span class="line" id="L229">    <span class="tok-kw">while</span> (iter.next()) |word| {</span>
<span class="line" id="L230">        <span class="tok-kw">if</span> (isLineBreak(word.bytes)) {</span>
<span class="line" id="L231">            <span class="tok-kw">try</span> result.append(<span class="tok-str">' '</span>);</span>
<span class="line" id="L232">            <span class="tok-kw">continue</span>;</span>
<span class="line" id="L233">        }</span>
<span class="line" id="L234">        <span class="tok-kw">try</span> result.appendSlice(word.bytes);</span>
<span class="line" id="L235">        line_width += <span class="tok-kw">try</span> strWidth(word.bytes, .half);</span>
<span class="line" id="L236"></span>
<span class="line" id="L237">        <span class="tok-kw">if</span> (line_width &gt; columns <span class="tok-kw">or</span> columns - line_width &lt;= threshold) {</span>
<span class="line" id="L238">            <span class="tok-kw">try</span> result.append(<span class="tok-str">'\n'</span>);</span>
<span class="line" id="L239">            line_width = <span class="tok-number">0</span>;</span>
<span class="line" id="L240">        }</span>
<span class="line" id="L241">    }</span>
<span class="line" id="L242"></span>
<span class="line" id="L243">    <span class="tok-kw">return</span> result.toOwnedSlice();</span>
<span class="line" id="L244">}</span>
<span class="line" id="L245"></span>
<span class="line" id="L246"><span class="tok-kw">fn</span> <span class="tok-fn">isLineBreak</span>(str: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L247">    <span class="tok-kw">if</span> (std.mem.eql(<span class="tok-type">u8</span>, str, <span class="tok-str">&quot;\r\n&quot;</span>)) {</span>
<span class="line" id="L248">        <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L249">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (std.mem.eql(<span class="tok-type">u8</span>, str, <span class="tok-str">&quot;\r&quot;</span>)) {</span>
<span class="line" id="L250">        <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L251">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (std.mem.eql(<span class="tok-type">u8</span>, str, <span class="tok-str">&quot;\n&quot;</span>)) {</span>
<span class="line" id="L252">        <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L253">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L254">        <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L255">    }</span>
<span class="line" id="L256">}</span>
<span class="line" id="L257"></span>
<span class="line" id="L258"><span class="tok-kw">test</span> <span class="tok-str">&quot;display_width Width&quot;</span> {</span>
<span class="line" id="L259">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, -<span class="tok-number">1</span>), codePointWidth(<span class="tok-number">0x0008</span>, .half)); <span class="tok-comment">// \b</span>
</span>
<span class="line" id="L260">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">0</span>), codePointWidth(<span class="tok-number">0x0000</span>, .half)); <span class="tok-comment">// null</span>
</span>
<span class="line" id="L261">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">0</span>), codePointWidth(<span class="tok-number">0x0005</span>, .half)); <span class="tok-comment">// Cf</span>
</span>
<span class="line" id="L262">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">0</span>), codePointWidth(<span class="tok-number">0x0007</span>, .half)); <span class="tok-comment">// \a BEL</span>
</span>
<span class="line" id="L263">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">0</span>), codePointWidth(<span class="tok-number">0x000A</span>, .half)); <span class="tok-comment">// \n LF</span>
</span>
<span class="line" id="L264">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">0</span>), codePointWidth(<span class="tok-number">0x000B</span>, .half)); <span class="tok-comment">// \v VT</span>
</span>
<span class="line" id="L265">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">0</span>), codePointWidth(<span class="tok-number">0x000C</span>, .half)); <span class="tok-comment">// \f FF</span>
</span>
<span class="line" id="L266">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">0</span>), codePointWidth(<span class="tok-number">0x000D</span>, .half)); <span class="tok-comment">// \r CR</span>
</span>
<span class="line" id="L267">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">0</span>), codePointWidth(<span class="tok-number">0x000E</span>, .half)); <span class="tok-comment">// SQ</span>
</span>
<span class="line" id="L268">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">0</span>), codePointWidth(<span class="tok-number">0x000F</span>, .half)); <span class="tok-comment">// SI</span>
</span>
<span class="line" id="L269"></span>
<span class="line" id="L270">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">0</span>), codePointWidth(<span class="tok-number">0x070F</span>, .half)); <span class="tok-comment">// Cf</span>
</span>
<span class="line" id="L271">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">1</span>), codePointWidth(<span class="tok-number">0x0603</span>, .half)); <span class="tok-comment">// Cf Arabic</span>
</span>
<span class="line" id="L272"></span>
<span class="line" id="L273">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">1</span>), codePointWidth(<span class="tok-number">0x00AD</span>, .half)); <span class="tok-comment">// soft-hyphen</span>
</span>
<span class="line" id="L274">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">2</span>), codePointWidth(<span class="tok-number">0x2E3A</span>, .half)); <span class="tok-comment">// two-em dash</span>
</span>
<span class="line" id="L275">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">3</span>), codePointWidth(<span class="tok-number">0x2E3B</span>, .half)); <span class="tok-comment">// three-em dash</span>
</span>
<span class="line" id="L276"></span>
<span class="line" id="L277">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">1</span>), codePointWidth(<span class="tok-number">0x00BD</span>, .half)); <span class="tok-comment">// ambiguous halfwidth</span>
</span>
<span class="line" id="L278">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">2</span>), codePointWidth(<span class="tok-number">0x00BD</span>, .full)); <span class="tok-comment">// ambiguous fullwidth</span>
</span>
<span class="line" id="L279"></span>
<span class="line" id="L280">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">1</span>), codePointWidth(<span class="tok-str">'é'</span>, .half));</span>
<span class="line" id="L281">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">2</span>), codePointWidth(<span class="tok-str">'😊'</span>, .half));</span>
<span class="line" id="L282">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">2</span>), codePointWidth(<span class="tok-str">'统'</span>, .half));</span>
<span class="line" id="L283"></span>
<span class="line" id="L284">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">5</span>), <span class="tok-kw">try</span> strWidth(<span class="tok-str">&quot;Hello\r\n&quot;</span>, .half));</span>
<span class="line" id="L285">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">1</span>), <span class="tok-kw">try</span> strWidth(<span class="tok-str">&quot;\u{0065}\u{0301}&quot;</span>, .half));</span>
<span class="line" id="L286">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">2</span>), <span class="tok-kw">try</span> strWidth(<span class="tok-str">&quot;\u{1F476}\u{1F3FF}\u{0308}\u{200D}\u{1F476}\u{1F3FF}&quot;</span>, .half));</span>
<span class="line" id="L287">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">8</span>), <span class="tok-kw">try</span> strWidth(<span class="tok-str">&quot;Hello 😊&quot;</span>, .half));</span>
<span class="line" id="L288">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">8</span>), <span class="tok-kw">try</span> strWidth(<span class="tok-str">&quot;Héllo 😊&quot;</span>, .half));</span>
<span class="line" id="L289">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">8</span>), <span class="tok-kw">try</span> strWidth(<span class="tok-str">&quot;Héllo :)&quot;</span>, .half));</span>
<span class="line" id="L290">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">8</span>), <span class="tok-kw">try</span> strWidth(<span class="tok-str">&quot;Héllo 🇪🇸&quot;</span>, .half));</span>
<span class="line" id="L291">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">2</span>), <span class="tok-kw">try</span> strWidth(<span class="tok-str">&quot;\u{26A1}&quot;</span>, .half)); <span class="tok-comment">// Lone emoji</span>
</span>
<span class="line" id="L292">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">1</span>), <span class="tok-kw">try</span> strWidth(<span class="tok-str">&quot;\u{26A1}\u{FE0E}&quot;</span>, .half)); <span class="tok-comment">// Text sequence</span>
</span>
<span class="line" id="L293">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">2</span>), <span class="tok-kw">try</span> strWidth(<span class="tok-str">&quot;\u{26A1}\u{FE0F}&quot;</span>, .half)); <span class="tok-comment">// Presentation sequence</span>
</span>
<span class="line" id="L294">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">1</span>), <span class="tok-kw">try</span> strWidth(<span class="tok-str">&quot;\u{2764}&quot;</span>, .half)); <span class="tok-comment">// Default text presentation</span>
</span>
<span class="line" id="L295">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">1</span>), <span class="tok-kw">try</span> strWidth(<span class="tok-str">&quot;\u{2764}\u{FE0E}&quot;</span>, .half)); <span class="tok-comment">// Default text presentation with VS15 selector</span>
</span>
<span class="line" id="L296">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">2</span>), <span class="tok-kw">try</span> strWidth(<span class="tok-str">&quot;\u{2764}\u{FE0F}&quot;</span>, .half)); <span class="tok-comment">// Default text presentation with VS16 selector</span>
</span>
<span class="line" id="L297">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">0</span>), <span class="tok-kw">try</span> strWidth(<span class="tok-str">&quot;A\x08&quot;</span>, .half)); <span class="tok-comment">// Backspace</span>
</span>
<span class="line" id="L298">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">0</span>), <span class="tok-kw">try</span> strWidth(<span class="tok-str">&quot;\x7FA&quot;</span>, .half)); <span class="tok-comment">// DEL</span>
</span>
<span class="line" id="L299">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">0</span>), <span class="tok-kw">try</span> strWidth(<span class="tok-str">&quot;\x7FA\x08\x08&quot;</span>, .half)); <span class="tok-comment">// never less than o</span>
</span>
<span class="line" id="L300">}</span>
<span class="line" id="L301"></span>
<span class="line" id="L302"><span class="tok-kw">test</span> <span class="tok-str">&quot;display_width center&quot;</span> {</span>
<span class="line" id="L303">    <span class="tok-kw">var</span> allocator = std.testing.allocator;</span>
<span class="line" id="L304"></span>
<span class="line" id="L305">    <span class="tok-comment">// Input and width both have odd length</span>
</span>
<span class="line" id="L306">    <span class="tok-kw">var</span> centered = <span class="tok-kw">try</span> center(allocator, <span class="tok-str">&quot;abc&quot;</span>, <span class="tok-number">9</span>, <span class="tok-str">&quot;*&quot;</span>);</span>
<span class="line" id="L307">    <span class="tok-kw">try</span> std.testing.expectEqualSlices(<span class="tok-type">u8</span>, <span class="tok-str">&quot;***abc***&quot;</span>, centered);</span>
<span class="line" id="L308"></span>
<span class="line" id="L309">    <span class="tok-comment">// Input and width both have even length</span>
</span>
<span class="line" id="L310">    allocator.free(centered);</span>
<span class="line" id="L311">    centered = <span class="tok-kw">try</span> center(allocator, <span class="tok-str">&quot;w😊w&quot;</span>, <span class="tok-number">10</span>, <span class="tok-str">&quot;-&quot;</span>);</span>
<span class="line" id="L312">    <span class="tok-kw">try</span> std.testing.expectEqualSlices(<span class="tok-type">u8</span>, <span class="tok-str">&quot;---w😊w---&quot;</span>, centered);</span>
<span class="line" id="L313"></span>
<span class="line" id="L314">    <span class="tok-comment">// Input has even length, width has odd length</span>
</span>
<span class="line" id="L315">    allocator.free(centered);</span>
<span class="line" id="L316">    centered = <span class="tok-kw">try</span> center(allocator, <span class="tok-str">&quot;1234&quot;</span>, <span class="tok-number">9</span>, <span class="tok-str">&quot;-&quot;</span>);</span>
<span class="line" id="L317">    <span class="tok-kw">try</span> std.testing.expectEqualSlices(<span class="tok-type">u8</span>, <span class="tok-str">&quot;--1234---&quot;</span>, centered);</span>
<span class="line" id="L318"></span>
<span class="line" id="L319">    <span class="tok-comment">// Input has odd length, width has even length</span>
</span>
<span class="line" id="L320">    allocator.free(centered);</span>
<span class="line" id="L321">    centered = <span class="tok-kw">try</span> center(allocator, <span class="tok-str">&quot;123&quot;</span>, <span class="tok-number">8</span>, <span class="tok-str">&quot;-&quot;</span>);</span>
<span class="line" id="L322">    <span class="tok-kw">try</span> std.testing.expectEqualSlices(<span class="tok-type">u8</span>, <span class="tok-str">&quot;--123---&quot;</span>, centered);</span>
<span class="line" id="L323"></span>
<span class="line" id="L324">    <span class="tok-comment">// Input is the same length as the width</span>
</span>
<span class="line" id="L325">    allocator.free(centered);</span>
<span class="line" id="L326">    centered = <span class="tok-kw">try</span> center(allocator, <span class="tok-str">&quot;123&quot;</span>, <span class="tok-number">3</span>, <span class="tok-str">&quot;-&quot;</span>);</span>
<span class="line" id="L327">    <span class="tok-kw">try</span> std.testing.expectEqualSlices(<span class="tok-type">u8</span>, <span class="tok-str">&quot;123&quot;</span>, centered);</span>
<span class="line" id="L328"></span>
<span class="line" id="L329">    <span class="tok-comment">// Input is empty</span>
</span>
<span class="line" id="L330">    allocator.free(centered);</span>
<span class="line" id="L331">    centered = <span class="tok-kw">try</span> center(allocator, <span class="tok-str">&quot;&quot;</span>, <span class="tok-number">3</span>, <span class="tok-str">&quot;-&quot;</span>);</span>
<span class="line" id="L332">    <span class="tok-kw">try</span> std.testing.expectEqualSlices(<span class="tok-type">u8</span>, <span class="tok-str">&quot;---&quot;</span>, centered);</span>
<span class="line" id="L333"></span>
<span class="line" id="L334">    <span class="tok-comment">// Input is empty and width is zero</span>
</span>
<span class="line" id="L335">    allocator.free(centered);</span>
<span class="line" id="L336">    centered = <span class="tok-kw">try</span> center(allocator, <span class="tok-str">&quot;&quot;</span>, <span class="tok-number">0</span>, <span class="tok-str">&quot;-&quot;</span>);</span>
<span class="line" id="L337">    <span class="tok-kw">try</span> std.testing.expectEqualSlices(<span class="tok-type">u8</span>, <span class="tok-str">&quot;&quot;</span>, centered);</span>
<span class="line" id="L338"></span>
<span class="line" id="L339">    <span class="tok-comment">// Input is longer than the width, which is an error</span>
</span>
<span class="line" id="L340">    allocator.free(centered);</span>
<span class="line" id="L341">    <span class="tok-kw">try</span> std.testing.expectError(<span class="tok-kw">error</span>.StrTooLong, center(allocator, <span class="tok-str">&quot;123&quot;</span>, <span class="tok-number">2</span>, <span class="tok-str">&quot;-&quot;</span>));</span>
<span class="line" id="L342">}</span>
<span class="line" id="L343"></span>
<span class="line" id="L344"><span class="tok-kw">test</span> <span class="tok-str">&quot;display_width padLeft&quot;</span> {</span>
<span class="line" id="L345">    <span class="tok-kw">var</span> allocator = std.testing.allocator;</span>
<span class="line" id="L346"></span>
<span class="line" id="L347">    <span class="tok-kw">var</span> right_aligned = <span class="tok-kw">try</span> padLeft(allocator, <span class="tok-str">&quot;abc&quot;</span>, <span class="tok-number">9</span>, <span class="tok-str">&quot;*&quot;</span>);</span>
<span class="line" id="L348">    <span class="tok-kw">defer</span> allocator.free(right_aligned);</span>
<span class="line" id="L349">    <span class="tok-kw">try</span> std.testing.expectEqualSlices(<span class="tok-type">u8</span>, <span class="tok-str">&quot;******abc&quot;</span>, right_aligned);</span>
<span class="line" id="L350"></span>
<span class="line" id="L351">    allocator.free(right_aligned);</span>
<span class="line" id="L352">    right_aligned = <span class="tok-kw">try</span> padLeft(allocator, <span class="tok-str">&quot;w😊w&quot;</span>, <span class="tok-number">10</span>, <span class="tok-str">&quot;-&quot;</span>);</span>
<span class="line" id="L353">    <span class="tok-kw">try</span> std.testing.expectEqualSlices(<span class="tok-type">u8</span>, <span class="tok-str">&quot;------w😊w&quot;</span>, right_aligned);</span>
<span class="line" id="L354">}</span>
<span class="line" id="L355"></span>
<span class="line" id="L356"><span class="tok-kw">test</span> <span class="tok-str">&quot;display_width padRight&quot;</span> {</span>
<span class="line" id="L357">    <span class="tok-kw">var</span> allocator = std.testing.allocator;</span>
<span class="line" id="L358"></span>
<span class="line" id="L359">    <span class="tok-kw">var</span> left_aligned = <span class="tok-kw">try</span> padRight(allocator, <span class="tok-str">&quot;abc&quot;</span>, <span class="tok-number">9</span>, <span class="tok-str">&quot;*&quot;</span>);</span>
<span class="line" id="L360">    <span class="tok-kw">defer</span> allocator.free(left_aligned);</span>
<span class="line" id="L361">    <span class="tok-kw">try</span> std.testing.expectEqualSlices(<span class="tok-type">u8</span>, <span class="tok-str">&quot;abc******&quot;</span>, left_aligned);</span>
<span class="line" id="L362"></span>
<span class="line" id="L363">    allocator.free(left_aligned);</span>
<span class="line" id="L364">    left_aligned = <span class="tok-kw">try</span> padRight(allocator, <span class="tok-str">&quot;w😊w&quot;</span>, <span class="tok-number">10</span>, <span class="tok-str">&quot;-&quot;</span>);</span>
<span class="line" id="L365">    <span class="tok-kw">try</span> std.testing.expectEqualSlices(<span class="tok-type">u8</span>, <span class="tok-str">&quot;w😊w------&quot;</span>, left_aligned);</span>
<span class="line" id="L366">}</span>
<span class="line" id="L367"></span>
<span class="line" id="L368"><span class="tok-kw">test</span> <span class="tok-str">&quot;display_width wrap&quot;</span> {</span>
<span class="line" id="L369">    <span class="tok-kw">var</span> allocator = std.testing.allocator;</span>
<span class="line" id="L370">    <span class="tok-kw">const</span> input = <span class="tok-str">&quot;The quick brown fox\r\njumped over the lazy dog!&quot;</span>;</span>
<span class="line" id="L371">    <span class="tok-kw">const</span> got = <span class="tok-kw">try</span> wrap(allocator, input, <span class="tok-number">10</span>, <span class="tok-number">3</span>);</span>
<span class="line" id="L372">    <span class="tok-kw">defer</span> allocator.free(got);</span>
<span class="line" id="L373">    <span class="tok-kw">const</span> want = <span class="tok-str">&quot;The quick\n brown \nfox jumped\n over the\n lazy dog\n!&quot;</span>;</span>
<span class="line" id="L374">    <span class="tok-kw">try</span> std.testing.expectEqualStrings(want, got);</span>
<span class="line" id="L375">}</span>
<span class="line" id="L376"></span>
</code></pre></body>
</html>